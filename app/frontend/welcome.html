<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caricamento Ordini - Schedulatore Laser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        /* Navbar */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            display: flex;
            align-items: center;
            padding: 0 30px;
            gap: 40px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        nav h1 {
            color: #27ae60;
            font-size: 20px;
            font-weight: 600;
            white-space: nowrap;
        }

        nav a {
            color: #ecf0f1;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-size: 14px;
            white-space: nowrap;
        }

        nav a:hover {
            background-color: rgba(39, 174, 96, 0.2);
        }

        nav a.active {
            background-color: #27ae60;
            color: white;
            font-weight: 600;
        }

        /* Main Content */
        main {
            margin-top: 90px;
            padding: 30px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            border-bottom: 2px solid #27ae60;
            padding-bottom: 10px;
        }

        /* Form Sections */
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-left: 4px solid #27ae60;
            border-radius: 4px;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"],
        input[type="file"],
        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="file"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #27ae60;
            box-shadow: 0 0 5px rgba(39, 174, 96, 0.3);
        }

        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Articoli Section */
        .articles-container {
            margin-top: 20px;
        }

        .article-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 12px;
            padding: 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            align-items: end;
        }

        .article-row input {
            margin: 0;
        }

        .btn-remove-article {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .btn-remove-article:hover {
            background: #c0392b;
        }

        .phases {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .phase-checkbox {
            width: auto;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .phase-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .phase-checkbox label {
            margin: 0;
            font-weight: normal;
        }

        .btn-add-article {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            margin-top: 10px;
        }

        .btn-add-article:hover {
            background: #2980b9;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #27ae60;
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            background: #229954;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-primary:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #27ae60;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav>
        <h1>üïê Schedulatore Laser</h1>
        <a href="welcome.html" class="active">Caricamento</a>
        <a href="ordini-estratti">üìä Ordini Estratti</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="laser.html">Laser</a>
        <a href="piega.html">Piega</a>
        <a href="saldatura.html">Saldatura</a>
        <a href="archive.html">Archivio</a>
    </nav>

    <main>
        <div class="container">
            <h2>üìã Caricamento Nuovo Ordine</h2>

            <div id="message" class="message"></div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Elaborazione in corso...</p>
            </div>

            <form id="orderForm">
                <!-- Sezione: Dati Ordine -->
                <div class="form-section">
                    <h3>1. Dati Ordine</h3>

                    <div class="two-columns">
                        <div class="form-group">
                            <label for="cliente">Cliente</label>
                            <input type="text" id="cliente" name="cliente" required>
                        </div>
                        <div class="form-group">
                            <label for="data_consegna">Data Consegna</label>
                            <input type="date" id="data_consegna" name="data_consegna" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pdfFile">üìÑ Carica PDF Ordine (opzionale)</label>
                        <input type="file" id="pdfFile" name="pdfFile" accept=".pdf">
                        <div class="file-info">Il PDF verr√† analizzato per estrarre automaticamente i dati</div>
                    </div>
                </div>

                <!-- Sezione: Articoli -->
                <div class="form-section">
                    <h3>2. Articoli</h3>

                    <div class="articles-container" id="articlesContainer">
                        <!-- Righe articoli aggiunte dinamicamente -->
                    </div>

                    <button type="button" class="btn-add-article" onclick="addArticle()">
                        + Aggiungi Articolo
                    </button>
                </div>

                <!-- Sezione: Fasi Richieste -->
                <div class="form-section">
                    <h3>3. Fasi Processo</h3>
                    <p style="margin-bottom: 15px; color: #7f8c8d; font-size: 14px;">
                        Seleziona quali fasi di lavoro sono richieste per questo ordine
                    </p>

                    <div class="phases">
                        <div class="phase-checkbox">
                            <input type="checkbox" id="phaseLaser" name="phases" value="LASER" checked>
                            <label for="phaseLaser">üî¥ LASER</label>
                        </div>
                        <div class="phase-checkbox">
                            <input type="checkbox" id="phasePiega" name="phases" value="PIEGA" checked>
                            <label for="phasePiega">üü° PIEGA</label>
                        </div>
                        <div class="phase-checkbox">
                            <input type="checkbox" id="phaseSaldatura" name="phases" value="SALDATURA" checked>
                            <label for="phaseSaldatura">üü† SALDATURA</label>
                        </div>
                        <div class="phase-checkbox">
                            <input type="checkbox" id="phasePulizia" name="phases" value="PULIZIA">
                            <label for="phasePulizia">üîµ PULIZIA</label>
                        </div>
                    </div>
                </div>

                <!-- Bottoni -->
                <div class="button-group">
                    <button type="submit" class="btn-primary">
                        ‚úÖ Salva Ordine
                    </button>
                    <button type="reset" class="btn-secondary">
                        üîÑ Pulisci
                    </button>
                </div>
            </form>
        </div>
    </main>

    <script>
        // Usa URL relativo per funzionare su localhost e IP
        const API_URL = '/api';

        // Aggiungi primo articolo al caricamento
        window.addEventListener('DOMContentLoaded', () => {
            console.log('‚úÖ Pagina caricata');
            addArticle();
            
            // Aggiungi listener per estrazione PDF
            const pdfInput = document.getElementById('pdfFile');
            console.log('PDF Input trovato?', pdfInput ? 'SI' : 'NO');
            
            if (pdfInput) {
                pdfInput.addEventListener('change', (e) => {
                    console.log('üì§ File PDF selezionato:', e.target.files[0]?.name);
                    handlePdfUpload(e);
                });
                console.log('‚úÖ Listener PDF aggiunto');
            } else {
                console.error('‚ùå Elemento #pdfFile non trovato!');
            }
        });

        function addArticle() {
            const container = document.getElementById('articlesContainer');
            const index = container.children.length;

            const row = document.createElement('div');
            row.className = 'article-row';
            row.innerHTML = `
                <div class="form-group">
                    <input type="text" placeholder="Nome articolo" class="article-name" required>
                </div>
                <div class="form-group">
                    <input type="text" placeholder="Codice" class="article-code">
                </div>
                <div class="form-group">
                    <input type="number" placeholder="Quantit√†" class="article-qty" value="1" required>
                </div>
                <button type="button" class="btn-remove-article" onclick="removeArticle(this)">
                    üóëÔ∏è Rimuovi
                </button>
            `;
            container.appendChild(row);
        }

        function removeArticle(btn) {
            const container = document.getElementById('articlesContainer');
            if (container.children.length > 1) {
                btn.parentElement.remove();
            } else {
                showMessage('Deve esserci almeno un articolo', 'error');
            }
        }

        async function handlePdfUpload(e) {
            const file = e.target.files[0];
            console.log('üîÑ handlePdfUpload eseguita');
            console.log('   File:', file?.name);
            
            if (!file) {
                console.warn('‚ö†Ô∏è Nessun file selezionato');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            console.log('üì§ Inizio upload verso:', API_URL + '/extract-pdf-data');
            console.log('   File:', file.name, 'Dimensione:', file.size, 'bytes');
            
            showLoading(true);
            try {
                console.log('   ‚Üí Invio fetch...');
                const response = await fetch(`${API_URL}/extract-pdf-data`, {
                    method: 'POST',
                    body: formData
                });

                console.log('   ‚úÖ Risposta ricevuta:', response.status);
                const data = await response.json();
                console.log('   üìä Data ricevuto:', JSON.stringify(data, null, 2));

                if (data.success) {
                    console.log('‚úÖ PDF elaborato con successo');
                    // Popola campi estratti dal PDF
                    const pdfData = data.data;
                    console.log('   Cliente (raw):', pdfData.cliente);
                    console.log('   Articoli trovati:', pdfData.articoli?.length || 0);
                    
                    const clientInput = document.getElementById('cliente');
                    const dataInput = document.getElementById('data_consegna');
                    console.log('   Campo cliente esiste?', clientInput ? '‚úÖ SI' : '‚ùå NO');
                    console.log('   Campo data esiste?', dataInput ? '‚úÖ SI' : '‚ùå NO');
                    
                    if (pdfData.cliente) {
                        console.log('   ‚Üí Popolo cliente con:', pdfData.cliente);
                        document.getElementById('cliente').value = pdfData.cliente;
                        console.log('   ‚úÖ Cliente popolato');
                    }
                    
                    if (pdfData.data_consegna) {
                        const dataValue = pdfData.data_consegna.split('T')[0];
                        console.log('   ‚Üí Popolo data con:', dataValue);
                        document.getElementById('data_consegna').value = dataValue;
                        console.log('   ‚úÖ Data popolata');
                    }

                    // Popola articoli se trovati
                    if (pdfData.articoli && pdfData.articoli.length > 0) {
                        console.log(`   ‚Üí Trovo ${pdfData.articoli.length} articoli, inizio popolazione...`);
                        clearArticles();
                        pdfData.articoli.forEach((articolo, i) => {
                            console.log(`   Articolo ${i}:`, articolo);
                            addArticleWithData(articolo);
                        });
                        showMessage(`‚úÖ PDF elaborato: trovati ${pdfData.articoli.length} articoli`, 'success');
                        console.log('‚úÖ SUCCESSO: Tutti gli articoli sono stati popolati');
                    } else {
                        console.warn('‚ö†Ô∏è Nessun articolo trovato nel PDF');
                    }
                } else {
                    console.error('‚ùå Errore nel parsing:', data.error);
                    showMessage('Errore nella lettura del PDF: ' + (data.error || 'Sconosciuto'), 'error');
                }
            } catch (error) {
                console.error('‚ùå Errore fetch:', error);
                showMessage('Errore caricamento PDF: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function addArticleWithData(articolo) {
            const container = document.getElementById('articlesContainer');

            const row = document.createElement('div');
            row.className = 'article-row';
            row.innerHTML = `
                <div class="form-group">
                    <input type="text" placeholder="Nome articolo" class="article-name" value="${articolo.name || ''}" required>
                </div>
                <div class="form-group">
                    <input type="text" placeholder="Codice" class="article-code" value="${articolo.code || ''}">
                </div>
                <div class="form-group">
                    <input type="number" placeholder="Quantit√†" class="article-qty" value="${articolo.qty || 1}" required>
                </div>
                <button type="button" class="btn-remove-article" onclick="removeArticle(this)">
                    üóëÔ∏è Rimuovi
                </button>
            `;
            container.appendChild(row);
        }

        function clearArticles() {
            const container = document.getElementById('articlesContainer');
            container.innerHTML = '';
        }

        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const cliente = document.getElementById('cliente').value;
            const data_consegna = document.getElementById('data_consegna').value;

            // Raccogliamo gli articoli
            const articles = [];
            document.querySelectorAll('.article-row').forEach(row => {
                const name = row.querySelector('.article-name').value;
                const code = row.querySelector('.article-code').value;
                const qty = parseInt(row.querySelector('.article-qty').value);

                if (name && qty > 0) {
                    articles.push({
                        name: name,
                        code: code || 'N/A',
                        qty: qty,
                        required_phases: getSelectedPhases()
                    });
                }
            });

            if (articles.length === 0) {
                showMessage('Aggiungi almeno un articolo', 'error');
                return;
            }

            // Raccogliamo le fasi
            const required_phases = getSelectedPhases();

            const orderData = {
                cliente: cliente,
                data_consegna: data_consegna + 'T00:00:00',
                articles: articles,
                required_phases: required_phases
            };

            showLoading(true);

            try {
                const response = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(`‚úÖ Ordine creato! ID: ${data.order_id}`, 'success');
                    document.getElementById('orderForm').reset();
                    clearArticles();
                    addArticle();

                    // Reindirizza a dashboard dopo 2 secondi
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                } else {
                    showMessage('Errore: ' + (data.error || 'Sconosciuto'), 'error');
                }
            } catch (error) {
                showMessage('Errore creazione ordine: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });

        function getSelectedPhases() {
            const phases = [];
            document.querySelectorAll('input[name="phases"]:checked').forEach(checkbox => {
                phases.push(checkbox.value);
            });
            return phases.length > 0 ? phases : ['LASER', 'PIEGA', 'SALDATURA'];
        }

        function showMessage(msg, type) {
            const msgBox = document.getElementById('message');
            msgBox.textContent = msg;
            msgBox.className = `message ${type}`;
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }
    </script>
</body>
</html>
